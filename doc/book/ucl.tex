\chapter{The Unicon Component Library}

\section{GUI Classes}

This section presents the various methods and class fields making up the
classes implemented in the Unicon GUI library. The library is a package
(gui) defined by a set of files in their own directory (uni/gui). In
this section if a class has superclasses, their names are given,
separated by colons. Superclasses should be consulted for additional
methods and class fields used by \index{subclass}subclasses. The
default is to have no superclass.
If a required field is omitted, an error message may be produced,
such as:

\iconcode{
gui.icn : error processing object TextList : x position unspecified}

\noindent This means that the x position of a TextList object was not specified,
probably because the \texttt{set\_pos()} method had not been invoked.

You will generally need to consult
"Graphics Programming in Icon", by
Griswold, \linebreak Jeffery, and Townsend
in order to make the best use of these classes.

\noindent {\ttfamily\bfseries \index{Notification}Notification}

An instance of this class is generated by components and passed to the
connected event handler method. It holds three elements, which
are accessed as follows:

\noindent\texttt{get\_source()} returns the component associated with the event. This may
be a subclass of either Component or a MenuComponent. If this is
\texttt{\&null}, then an Icon event has occurred which has not produced an Event
from any component.

\noindent\texttt{get\_type()} returns a field to distinguish between different types of
event generated by the same component (\texttt{ACTION\_EVENT},
\texttt{MOUSE\_PRESS\_EVENT}, etc.).

\noindent\texttt{get\_param()} returns the parameter associated with the event, if any.

\noindent{\ttfamily\bfseries \index{Dialog}Dialog : Container}

This is the parent class of a dialog window.

\noindent\texttt{resize\_win(w, h)} resizes the window to the given dimensions.

\noindent\texttt{get\_win()} returns the Icon window associated with the dialog.

\noindent\texttt{set\_min\_size(w, h)} sets the minimum dimensions for a window. The user
will not be able to resize the window below this size.

\noindent\texttt{set\_focus(c)} sets the keyboard focus to component \texttt{c}.
\texttt{clear\_focus()} clears the focus.

\noindent\texttt{dialog\_event(e:Event)} must be defined in the subclass. It is
invoked on each event.

\noindent\texttt{dispose(x)} is normally invoked in response to an event.
It sets a
flag to indicate that the dialog should be closed. If x is non-null,
the window is closed already.

\noindent\texttt{set\_unique(c)} is called by a component c to indicate the beginning of
unique event processing, whereby one component alone receives all
events.\\
\texttt{clear\_unique(x)} unsets unique event processing mode. If x is \&null
then the final event in unique processing mode will be passed to all
objects; otherwise it will not.

\texttt{show\_modal(d)} opens and displays the dialog window, and accepts events
into it. As events occur they are handled, until a call to dispose()
is made, then the window is closed and the method returns. Parameter d
is the parent dialog, if any.

\texttt{Open()} opens the dialog window.
\texttt{Close()} closes the dialog window.

\texttt{process\_event(e)} processes Icon event e, calling event handlers.

\texttt{win : window} is the dialog's window.\\
\texttt{is\_open : flag} indicates whether the window is open.

\texttt{focus : Component} specifies the component with the current focus.

\texttt{unique\_flag : flag} controls unique processing, where one
component receives all events.

\texttt{re\_process\_flag : flag} tells whether to distribute last
Icon event during unique mode.\\
\texttt{buffer\_win} is a buffer window for double buffering.\\
\texttt{min\_width : integer} is the minimum width of window, or \texttt{\&null} if no
minimum.\\
\texttt{min\_height : integer} is the minimum height of window, or \texttt{\&null} if no
minimum.

\noindent{\ttfamily\bfseries \index{Component}Component}

This is the parent class of all the GUI components. All of its methods
and variables therefore apply to its sub-classes.

\texttt{get\_x\_reference()}, \texttt{get\_y\_reference()},
\texttt{get\_w\_reference()}, and
\texttt{get\_h\_reference()} produce this
object's x position, y position, width, and height
values from which to compute absolute positions. May be over-ridden;
by default returns \texttt{self.x}, \texttt{self.y}, \texttt{self.w},
\texttt{self.h}.

\texttt{get\_cwin\_reference()}, \texttt{get\_cbwin\_reference()} produce
the cloned window (the reference object inherits the attributes by
cloning this window) and cloned buffer window.

\texttt{fatal(s)} prints an error message s together with the class name, and
stops the program.

\texttt{generate\_components() : Component*} generates the components for the
object. By default this just returns the component itself.

\texttt{is\_shaded() : flag?} succeeds if the component is shaded. A shaded
component, such as a button, may be displayed differently, and will not
generate events.\\
\texttt{set\_is\_shaded()} sets the shaded status of the component to
shaded.\\
\texttt{clear\_is\_shaded()} sets the shaded status of the component to not
shaded.\\
\texttt{toggle\_is\_shaded()} swaps the shaded status of the component.

\texttt{set\_draw\_border()} sets the component such that a border is
drawn.\\
\texttt{clear\_draw\_border()} sets the component such that a border is not
drawn.\\
\texttt{toggle\_draw\_border()} toggles whether or not to draw a border around
the component. Different objects respond differently to this flag being
set; some ignore it altogether.

\texttt{display(buffer\_flag)} draws, or re-draws, the component in the dialog
window. If \texttt{buffer\_flag} is not null, then the component is displayed
into the buffer window, not the dialog window (this is used for
double-buffering purposes).

\texttt{set\_accepts\_tab\_focus()} sets the
\texttt{accepts\_tab\_focus\_flag}, meaning
that the object will gain the keyboard focus by way of the user
pressing the tab key repeatedly.\\
\texttt{clear\_accepts\_tab\_focus()} clears the accepts\_tab\_focus\_flag.

\texttt{attrib(x[])} sets the graphic attributes of the component to the given
parameter list. For example:
w.attrib("font=helvetica",
"bg=pale blue"). Arguments may be either
strings or lists of strings. A description of the attributes is in
Chapter 7 and detailed in \cite{GJT98}.

\texttt{get\_parent\_win() : window} returns the window in which
the component resides.

\texttt{set\_pos(x, y)} sets the x and y position of the component. Each
coordinate can be either an absolute pixel position, or a
percentage plus or minus an offset.

{\ttfamily
\ \ \ \ \ \ \ \ \ \ c.set\_pos(100, "25\%") \\
\ \ \ \ \ \ \ \ \ \ c.set\_pos("50\%-20", "25\%+100")}

{\ttfamily set\_align(x\_align:"l",
y\_align:"t")} sets the alignment of the
component. Options for x\_align are "l", "c" and "r",
for left, center, and right alignment. Options for y\_align are
"t", "c" and "b", for top center and bottom alignment.
Examples:

\iconcode{
\>  \# Place c centered in the center of the window, \\
\>  \# its top left corner at (10,10). \\
\>  c.set\_pos("50\%", "50\%") \\
\>  c.set\_align("c", "c") \\
\>  c.set\_pos(10, 10) \\
\>  c.set\_align("l", "t")
}

\texttt{set\_size(w, h)} sets the size of the component; parameters are as
for \texttt{set\_pos()} above. Some components have sensible default sizes,
but on others the size must be set explicitly.

\texttt{handle\_event(e) : Event?} is over-ridden by all this
class's subclasses. It is the method that handles an
Icon event e. It would not normally be called by a user program. Its
result is passed to the \texttt{dialog\_event()} method of the dialog.

The first two fields of the Event structure are the Icon event e and the
object itself. The third field is the code, which can be any integer.
For example:

\iconcode{
\>   \ \ \ \ \ \ \ method handle\_event(e) \\
\>   \ \ \ \ \ \ \ \ \ \ ... \\
\>   \ \ \ \ \ \ \ \ \ return Event(e, self, 0) \\
\>   \ \ \ \ \ \ \ end
}

\texttt{do\_shading(w)} is called from a component's
\texttt{display()}
method. This method filters the component to give a shaded appearance
if the \texttt{is\_shaded\_flag} is set. \texttt{w} is the window to
use (normally \texttt{cwin}).

\texttt{in\_region(x:\&x,y:\&y)} succeeds for unshaded components if
(x,y) lies within the component.

\texttt{got\_focus()} is called when the component gets the keyboard focus. It
may be extended in subclasses. For example:

\iconcode{
\>   \ \ method got\_focus() \\
\>   \ \ \ \ self\$Component.got\_focus() \\
\>   \ \ \ \ \# \\
\>   \ \ \ \ \# Display the box cursor \\
\>   \ \ \ \ \# \\
\>   \ \ \ \ display() \\
\>   \ \ end
}

\texttt{lost\_focus()} is called when the component loses the keyboard focus; it
may be extended.

\texttt{unique\_start()} initiates unique event processing for this object by
calling the parent dialog's \texttt{set\_unique()}
method.\\
\texttt{unique\_end(x)} ends unique event processing for this object by calling
the parent dialog's \texttt{clear\_unique(x)} method.

\texttt{init()} sets up the cloned windows for the component. This method should
be called for any components created and used inside any custom
components.

\texttt{set\_parent\_dialog(x)} sets the owning Dialog of the component to
x.\\
\texttt{get\_parent\_dialog() : Dialog} returns the parent dialog of the
component.

\texttt{firstly()} is invoked after the position of the object has been
computed,
but before the object has been displayed in the window. This method may
be extended in subclasses.\\
\texttt{finally()} is invoked before the window is closed; it may
be extended in subclasses:

\iconcode{
\>   \ \ \ \ \ \ \ method finally() \\
\>   \ \ \ \ \ \ \ \ \ \ self\$Component.finally() \\
\>   \ \ \ \ \ \ \ \ \ \ \# Do something here \\
\>   \ \ \ \ \ \ \ \ \ \ ... \\
\>   \ \ \ \ \ \ \ \ \ \ return \\
\>   \ \ \ \ \ \ \ end
}

\texttt{resize()} computes the absolute positions and sizes from the
specifications given by \texttt{set\_pos()} and
\texttt{set\_size()}. This method needs
to be extended for a component that contains other components. See the
section on custom components for an example.

\texttt{x\_spec}, \texttt{y\_spec} are the x and y positions as specified by \texttt{set\_pos()},
e.g. "50\%"\\
\texttt{w\_spec}, \texttt{h\_spec} are the width and height specifiers
as used in \texttt{set\_size()}, e.g. "100\%"\\
\texttt{x\_align}, \texttt{y\_align} are the x and y alignment as specified in
\texttt{set\_align()}, e.g. "l",
"b".

The following four attributes are absolute dimensions in pixels,
compiled from \texttt{x\_spec}, \texttt{y\_spec}, \texttt{w\_spec},
and \texttt{h\_spec}, and the
dimensions of the enclosing object or window.

\texttt{x} and \texttt{y} are the x and y positions computed from x\_spec and
y\_spec.\\
w and h are the width and height computed from w\_spec and h\_spec.

\texttt{cwin} is a cloned window created by combining the
Dialog's canvas with the Component's
attributes, so drawing into this window will draw straight to the
Dialog window with the correct attributes. cbwin is a cloned window
created by combining a buffer window with the
Component's attributes. This is used solely for
double-buffering purposes.

\texttt{parent\_dialog} is the Dialog class \index{instance}instance of which
this Component is a part.

\texttt{attribs} is a list of strings specifying graphics attributes, e.g.
\texttt{["bg=blue", "resize=on"]}.

\texttt{has\_focus : flag} indicates whether the Component currently has the
keyboard focus.

\texttt{accepts\_tab\_focus\_flag : flag} indicates whether the
Component accepts keyboard focus by way of the tab key being pressed.

\texttt{draw\_border\_flag : flag} indicates whether the Component should have a
border drawn around it. Many components (such as TextButtons) ignore
this flag.

\texttt{is\_shaded\_flag : flag} indicates whether the Component
currently is shaded.

\texttt{reference} links to the object used to calculate absolute sizes from
percentage sizes. For objects placed directly in the Dialog, rather
than in some other object, this will point to the Dialog itself,
which over-rides the several methods get\_x\_reference() etc.,
appropriately.

\noindent {\ttfamily\bfseries \index{Container}Container : Component}

This class contains other components. The container itself is
invisible. Many of \texttt{Component}'s methods are over-ridden
by \texttt{Container}. A \texttt{Dialog} is a sub-class of this
class.\\
\texttt{add(c:Component)} adds the component c to the Container.\\
Instance variable \texttt{components} are the components inside the Container.

\noindent {\ttfamily\bfseries
\index{VisibleContainer}VisibleContainer : Component}

This is similar to a Container, except that the object itself is a
capable of display.\\
\texttt{add(c:Component)} adds the component c to the VisibleContainer.\\
components are the components inside the VisibleContainer.

\noindent{\ttfamily\bfseries \index{Button}Button : Component}

This is the parent class of button classes including TextButton and
IconButton. A button produces an Event of code 0 when the button is
depressed, and code 1 when it is released. By default, when a button
holds the \index{keyboard}keyboard focus a dashed line appears just
within the button. When return is pressed an event of code 2 is
generated. The method \texttt{Dialog.set\_initial\_focus()} can be used to give
the button the keyboard focus when the dialog is first displayed.

\texttt{set\_no\_keyboard()} disables the keyboard control over the button
described above. No dashed line will ever appear in the button
display and return will have no effect on the button even if it has the
focus.

\noindent {\ttfamily\bfseries \index{TextButton}TextButton : Button}

A button with a text label. The size of the button can either be set
using \texttt{set\_size()} or be left to default to a size based on the given
label.

\texttt{set\_internal\_alignment(x)} sets the alignment of the label within the
button. The parameter should be either "l", "c" or "r" to
set the alignment to left, center or right respectively. If this method
is not invoked, then the alignment is centered.

\texttt{set\_label(x)} sets the label in the button to the given string.
Examples:

\iconcode{
\>   b := TextButton() \\
\>   b.set\_label("Cancel") \\
\>   b.set\_pos("50\%",
"80\%") \\
\>   b.set\_align("c",
"c") \\
\>   add(b)
}

\noindent {\ttfamily\bfseries \index{IconButton}IconButton : Button}

This is a button with an Icon image within it. There is a useful program
in the Icon program library called xpmtoims, which will take an xpm
file and output the equivalent Icon image string, which can then be
inserted into a program. See also the X Window programs sxpm and pixmap
for viewing and editing xpm files respectively.

A border may be requested with set\_draw\_border(). Unless explicitly
specified, the size will default to the image's size,
plus a standard surrounding area if a border is requested.

\texttt{set\_img(s:string)} sets the image to \texttt{s}, which should
be in Icon image format. Examples:

\iconcode{
\>   \# Create a button with a diamond image and a border \\
\>   b := IconButton() \\
\>   b.set\_draw\_border() \\
\>   b.set\_img("11,c1,\_ \\
\ \  \ \ \~{}\~{}\~{}\~{}\~{}0\~{}\~{}\~{}\~{}\~{}\_ \\
\ \  \ \ \~{}\~{}\~{}\~{}000\~{}\~{}\~{}\~{}\_ \\
\ \  \ \ \~{}\~{}0000000\~{}\~{}\_ \\
\ \  \ \ \~{}000000000\~{}\_ \\
\ \  \ \ \~{}\~{}0000000\~{}\~{}\_ \\
\ \  \ \ \~{}\~{}\~{}\~{}000\~{}\~{}\~{}\~{}\_ \\
\ \  \ \ \~{}\~{}\~{}\~{}\~{}0\~{}\~{}\~{}\~{}\~{}\_ \\
\ \  \ \ ")
}

\noindent {\ttfamily\bfseries \index{ButtonGroup}ButtonGroup}

This class groups several Buttons together. Then, when the mouse is
clicked down on one of the Buttons and then dragged onto another before
being released, the other Button will go
"down". This is the common behavior for
buttons in a bar along the top of an application.

Note: a Button must be added to both the ButtonGroup and the Dialog too.
Examples:

\iconcode{
\>   bg := ButtonGroup() \\
\>   b := TextButton() \\
\>   b.set\_label("Okay") \\
\>   add(b) \\
\>   bg.add(b)
}

\texttt{add(c:Button)} adds the given Button to the ButtonGroup.

{\ttfamily\bfseries
\noindent \index{Label}Label : Component}

This simply creates a text label in the dialog window. Calling
\texttt{set\_draw\_border()} adds a border around the label. The size will
default if not set.

\texttt{set\_label(s:string)} sets the label to the given string.

\texttt{set\_internal\_alignment(x)} sets the horizontal alignment of the label
within the area of the component; should be "l", "c" or "r". Default is
"l". If the horizontal size is left to
default, then setting this field should make no difference, because the
size of the component will be set so that the string just fits into it.

\noindent {\ttfamily\bfseries \index{Icon}Icon : Component}

This displays an icon, supplied in Icon image format. A border may be
requested with \texttt{set\_draw\_border()}. The size defaults to the
image's size, plus a standard surrounding area if a
border is requested. \texttt{set\_img(s:string)} sets the image to be displayed.

{\ttfamily\bfseries
\index{Image}Image : Component}

This class loads an image from a file and displays it. The image should
be in GIF format. A border may be included with \texttt{set\_draw\_border()}.
The size of the area into which the image is drawn must be set with
\texttt{set\_size()}.

\texttt{set\_filename(s:string)} sets the name of the file from which to load
the image; redisplay the image from the new file if appropriate.

\texttt{set\_scale\_up()} scales the image up to fit in the space
specified by \texttt{set\_size()}. The image is not distorted, but will be
expanded to fill one of the dimensions depending on its shape. If the
image is bigger than the specified size then it will be scaled down.

\texttt{set\_internal\_alignment(x:"c", y:"c")} sets the horizontal
and vertical alignment of the image within the component;
x should be \texttt{"l"}, \texttt{"c"} or \texttt{"r"},
y should be \texttt{"t"}, \texttt{"c"} or \texttt{"b"}.

\noindent {\ttfamily\bfseries \index{Border}Border : VisibleContainer}

This class provides decorative borders. The \texttt{add(c)} method
may optionally be used to set one other
component to be the title of the Border. This would normally be a
Label object, but it could also be a CheckBox, Icon, or whatever is
desired.

\texttt{set\_internal\_alignment(x)} sets the alignment of the title
to \texttt{"l"}, \texttt{"c"} or \texttt{"r"}.

\iconcode{
\>   b := Border() \\
\>   \# \\
\>   \# Add a Label as the title \\
\>   \# \\
\>   l := Label() \\
\>   l.set\_label("Title String") \\
\>   b.add(l) \\
\>   add(b)
}

\noindent {\ttfamily\bfseries \index{ScrollBar}ScrollBar : Component}

This class provides horizontal and vertical scroll bars.
The first way to use a scroll bar is to set a total\_size
(represented by the whole bar), a page\_size (represented by the
draggable button) and an increment\_size (being the amount
added/subtracted when the top/bottom button is pressed). The value
then ranges from zero to (total\_size - page\_size) inclusive. An
initial value must be set with the \texttt{set\_value()} method. For example:

\iconcode{
\>   vb := ScrollBar() \\
\>   vb.set\_pos("85\%",
"25\%") \\
\>   vb.set\_size(20, "40\%") \\
\>   vb.set\_total\_size(130) \\
\>   vb.set\_page\_size(30) \\
\>   vb.set\_increment\_size(1) \\
\>   vb.set\_value(0) \\
\>   add(vb)
}

Alternatively, a scroll bar can be used as a slider over a given range
of values. In this case, the range is set with \texttt{set\_range()}.
It is still necessary to set the \texttt{increment\_size} and the
\texttt{initial\_value}, but \texttt{page\_size} and
\texttt{total\_size} should not be set.
Real numbers as opposed to integers can be used for the range settings
if desired. For example:

\iconcode{
\>   vb := ScrollBar() \\
\>   vb.set\_pos("85\%",
"25\%") \\
\>   vb.set\_size(20, "40\%") \\
\>   vb.set\_range(2, 25) \\
\>   vb.set\_value(10) \\
\>   vb.set\_increment\_size(1) \\
\>   add(vb)
}

An Event is returned whenever the buttons are pressed or the bar
dragged; the value can be retrieved by \texttt{get\_value()}. The event code
(obtainable by \texttt{get\_code()}) is 1 if the bar has been dragged, and 0 if
either button has been pressed or the bar released after being dragged.
This fact can be used to reduce the number of events which are
processed by the user's program - just ignore events
with code 1.

\texttt{set\_is\_horizontal()} makes the scroll bar horizontal (default is
vertical).\\
\texttt{set\_range(x, y)} sets the scroll bar range (integer or real)
from x to y inclusive.

\texttt{set\_total\_size(x)} sets the total size which the scroll bar area
represents.\\
\texttt{get\_total\_size()} returns the total size.\\
\texttt{set\_page\_size(x)} sets the size that the bar in the scroll bar area
represents.\\
\texttt{get\_page\_size()} gets the page size.

\texttt{set\_value(x)} sets the value representing the top of the bar in the
scroll bar. The value is forced into range if it is not in range
already.\\
\texttt{get\_value()} gets the value.\\
\texttt{set\_increment\_size(x)} sets the amount by which to increase when a
button is pressed.

\noindent {\ttfamily\bfseries \index{TextField}TextField : Component}

TextField is a class for a single input line of text. The text can
scroll within the area specified. By default, a border surrounds the
text area; this can be turned of by using clear\_draw\_border(). The
horizontal size must be set by the set\_size() method: there is no
default (the vertical size will default, however). An event is
generated when return is pressed (with code 0), and whenever the
contents are changed (with code 1).

\texttt{get\_contents()} returns the present contents of the text field.
\texttt{set\_contents(x)} sets the contents of the field. If not invoked then
the initial content is the empty string. Examples:

\iconcode{
\>   t := TextField() \\
\>   t.set\_pos(50, 250) \\
\>   \# Vertical size will default \\
\>   t.set\_size(100) \\
\>   t.set\_contents("Initial string") \\
\>   add(t)
}

\texttt{set\_displaychar()} controls whether the characters that are typed
into the text field are displayed or not. \texttt{set\_displaychar("*")}
will display a ``\texttt{*}'' character for each character typed (useful
for hiding passwords). The default is \texttt{set\_displaychar(\&null)}
which displays the typed characters normally.

\noindent {\ttfamily\bfseries \index{CheckBox}CheckBox : Component}

This class creates a small button with a label which is either
in an on or off state. The button is an Icon image, which may be
specified by the user if desired. The images and size default to
appropriate values if not specified.

\texttt{set\_imgs(x, y)} sets the up/down images for the button. The images
should be in Icon image format. The two images must have the same
dimensions.

\texttt{is\_checked()} succeeds if the button is down (checked); fail
otherwise.\\
\texttt{toggle\_is\_checked()} toggles the initial status of the button.\\
\texttt{set\_is\_checked()} sets the status of the button to checked.\\
\texttt{clear\_is\_checked()} sets the status of the button to not checked.

\texttt{set\_label(x)} sets the label of the component to the given
string.\\
\texttt{get\_status()} returns 1 if the CheckBox is checked,
\texttt{\&null} otherwise.
Examples:

\iconcode{
\>   c := CheckBox() \\
\>   c.set\_pos(200, 100) \\
\>   c.set\_label("Checkbox") \\
\>   add(c)
}

\noindent {\ttfamily\bfseries \index{CheckBoxGroup}CheckBoxGroup}

This class contains \texttt{CheckBox} objects that act together as
"radio buttons". The image style of \texttt{CheckBox}es in a
CheckBoxGroup draws diamonds rather
than boxes. The status of a CheckBoxGroup should be set with the
\texttt{set\_which\_one()} method, not by turning the individual CheckBoxes
on/off with their own methods - that would confuse the program. Note: a
CheckBox must be added to both the CheckBoxGroup and the dialog box.

\texttt{set\_by\_flag(i)} sets the CheckBox which is down according to the
integer i. If i = 1 then the first CheckBox is down, if i = 2 the
second is down, etc for i = 4, 8, 16.\\
\texttt{get\_by\_flag()} returns an integer in the range 1, 2, 4, 8 ...
depending upon whether the first, second, third etc CheckBox is down.

\texttt{add(c:CheckBox)} adds c to the CheckBoxGroup.

\texttt{get\_which\_one()} returns the CheckBox which is currently down.\\
\texttt{set\_which\_one(x:CheckBox)} sets which CheckBox is down to x. Examples:

\iconcode{
\>   \# \\
\>   \# Create a CheckBoxGroup of 3 CheckBoxes \\
\>   \# \\
\>   c := CheckBoxGroup() \\
\>   c1 := CheckBox() \\
\>   c1.set\_pos(200, 50) \\
\>   c1.set\_label("Checkbox 1") \\
\>   add(c1) \\
\>   c.add(c1) \\
\ \\
\>   c2 := CheckBox() \\
\>   c2.set\_pos(200, 90) \\
\>   c2.toggle\_is\_shaded() \\
\>   c2.set\_label("Checkbox 2") \\
\>   add(c2) \\
\>   c.add(c2) \\
\ \\
\>   c3 := CheckBox() \\
\>   c3.set\_pos(200, 130) \\
\>   c3.set\_label("Checkbox 3") \\
\>   add(c3) \\
\>   c.add(c3) \\
\>   \# \\
\>   \# Initially, set the first one "on" \\
\>   \# \\
\>   c.set\_which\_one(c1)
}

\noindent {\ttfamily\bfseries \index{TextList}TextList : Component}

This class displays a list of strings. See the class EditableTextList
if you require a multiline text input region. Horizontal and
vertical scroll bars are displayed if necessary.

Optionally the user can be allowed to
select either one line only, or several lines. In either case, an
event is generated when a line is selected.

\texttt{get\_contents()} : list returns the current contents as a list of
strings.\\
\texttt{set\_contents(x:list, line, left\_pos, preserve\_selections)} sets the
contents to \texttt{x} and sets the position to line and left\_pos. If
these parameters are omitted then the default is to start at line 1,
with left offset zero if the window is not already open, or to retain
the existing position if it is. If the last parameter is non-null then
the current selections are retained; otherwise they are reset. This
method has no effect if the component is in editable mode and the
window is already open.

\iconcode{
\>   \ \ tl := TextList() \\
\>   \ \ tl.set\_contents(data) \\
\>   \ \ \ ... \\
\>   \ \ \# Amend data and go to end of data \\
\>   \ \ put(data, "New line") \\
\>   \ \ tl.set\_contents(data, *data, 0)
}

The method \texttt{set\_select\_one()} specifies that only one line of the list
may be highlighted, while method \texttt{set\_select\_many()} specifies that
several lines of the list may be highlighted. Of no effect if in editable mode.

\texttt{get\_selections()} : list returns a list of the numbers of the lines
that are highlighted.\\
\texttt{set\_selections(L)} sets the highlighted selections to a
given list of line numbers.

\iconcode{
\>   tl := TextList() \\
\>   tl.set\_pos("50\%",
"50\%") \\
\>   tl.set\_size("70\%",
"50\%") \\
\>   tl.set\_align("c",
"c") \\
\>   tl.set\_contents(data) \# data is a list of strings \\
\>   add(tl)
}

\noindent {\ttfamily\bfseries \index{DropDown}DropDown}

This class is a superclass of List and EditList below.

\texttt{set\_selection\_list(x)} sets the list of selections to the list
x.\\
\texttt{get\_selection():integer} returns the index of the item in the
list presently selected.

\noindent {\ttfamily\bfseries \index{List}List : Component : DropDown}

This component is for selecting one string from a list. When
a button is pressed a list appears (possibly with a scroll bar) from
which one item can be selected. An Event is generated whenever an item
is selected. A width must be specified for this component.

\texttt{set\_selection(x)} sets the selected item to element x.\\
\texttt{set\_constant\_label(x)} supplies a string that will always appear in
the text part of the component, rather than the currently selected item.

The methods for handling the list of selections are mostly
inherited from \texttt{DropDown}.

\iconcode{
\>   L := List() \\
\>   L.set\_selection\_list(["Red","Green","Yellow","Blue","Orange"]) \\
\>   L.set\_size(120) \\
\>   L.set\_pos(100, 100) \\
\>   L.set\_selection(2) \# Green will be the first selection \\
\>   add(L)
}

\noindent{\ttfamily\bfseries \index{EditList}EditList : Component : DropDown}

An \texttt{EditList} works like a \texttt{List}, but the user may
edit the item that is selected. An extra method is therefore supplied
to get the content, as it may not correspond to an element of the list.
An Event is generated with code 0 if an element of the list is
selected, with code 1 if return is pressed, and with code 2 if the user
edits the selected item.

\texttt{get\_contents()} returns the contents of the selected item (which may
have been edited).\\
\texttt{set\_contents(x)} sets the initial contents of the text to the given
string.

\noindent {\ttfamily\bfseries \index{MenuBar}MenuBar : Component}

This class is the base from which menu systems are created. Menu items
are added to this class; they are not separate components added to the
dialog itself. The default position is (0, 0); the default size is
100\% of the width of the screen and a reasonable height based on the
font specified. add(c:Menu) adds c to the MenuBar. This will be one
drop down menu. Items are then added to the Menu.

\noindent {\ttfamily\bfseries \index{MenuButton}MenuButton : Component}

This is similar to MenuBar, but holds just a single drop-down menu,
rather than several. \texttt{set\_menu(x:Menu)} sets the menu to be displayed
when the component is clicked.

\noindent {\ttfamily\bfseries \index{MenuComponent}MenuComponent}

This is the superclass of all the objects that make up the menu system
(other than MenuBar of course). For components that appear in a menu
with a label, an optional left/right string/image can be set.

\texttt{set\_label\_left(x)} sets the optional left label to the given
string.\\
\texttt{set\_label\_right(x)} sets the optional right label to the given
string.\\
\texttt{set\_img\_left(x)} sets the optional left image to the given Icon
image.\\
\texttt{set\_img\_right(x)} sets the optional right image to the given Icon
image.

\texttt{toggle\_is\_shaded()} toggles whether or not the item is shaded. If it
is, it is\\
 \ \ \ \ \ displayed in a filtered way and will not accept input.

\texttt{set\_is\_shaded()} sets the shaded status of the component to
shaded.\\
\texttt{clear\_is\_shaded()} sets the shaded status of the component to not
shaded.

\texttt{set\_label(x)} sets the center label to the given string.

\noindent {\ttfamily\bfseries \index{SubMenu}SubMenu : MenuComponent}

This class encapsulates a \texttt{Menu} object that when selected will
display something outside the menu itself (for example a sub-menu of
other menu items). It is intended to be extended by custom menu
components, and should not be instantiated. Methods are empty.

\texttt{hide\_non\_menu()} and \texttt{set\_which\_open(x)} are called
by Menu for any SubMenu object,
but would not normally need to be over-ridden by a custom class.

\texttt{resize()} may be overridden to initialize the width and height
of the object.

\texttt{display()} must be over-ridden; it displays the object.

\texttt{handle\_event(e)} handles the Icon event e and must be over-ridden.

\texttt{hide()} hides (closes) the object's display and must be
over-ridden.

\noindent {\ttfamily\bfseries \index{Menu}Menu : SubMenu}

This class encapsulates a drop down menu, or a sub-menu. The left,
center and right labels/images of the elements within it are formatted
within the menu automatically.

\texttt{add(c:Component)} adds the given component to the Menu.

\noindent{\ttfamily\bfseries TextMenuItem : MenuComponent}

This class encapsulates a single text item in a Menu. It has no
additional methods that the user need call other than are contained in
its parent class, MenuComponent.

\noindent{\ttfamily\bfseries
\index{CheckBoxMenuItem}CheckBoxMenuItem : MenuComponent}

This class encapsulates a check box in a menu. Several CheckBoxMenuItems
may be added to a CheckBoxGroup structure to give "radio
buttons" within menus.

\texttt{set\_imgs(x, y)} sets the up and down images to x and y respectively.
The default is boxes, unless
the component is in a CheckBoxGroup in which case the
default is diamonds.

\texttt{is\_checked()} succeeds if the component is checked; fail
otherwise.\\
\texttt{set\_is\_checked()} sets the status of the button to checked.\\
\texttt{clear\_is\_checked()} sets the status of the button to not checked.

\noindent{\ttfamily\bfseries
\index{MenuSeparator}MenuSeparator : MenuComponent}

This is a horizontal bar in a Menu, for decorative purposes. It
has no user methods.

\noindent{\ttfamily\bfseries
\index{TableColumn}TableColumn : TextButton}

This class provides one column within a Table class, which displays a
table of data. A column has a label with a button that produces an
event when clicked. The column may be expanded or contracted by
dragging the right edge of the button. Calling the set\_label(x) method
of the superclass, TextButton, sets the label.

\texttt{set\_column\_width(x)} sets the initial width of the column in pixels;
this is required.

\iconcode{
\>   c1 := TableColumn() \\
\>   c1.set\_internal\_alignment("r") \#
Label is right aligned \\
\>   c1.set\_column\_width(80) \\
\>   c1.set\_label("Number")
}

\noindent{\ttfamily\bfseries
\index{Table}Table : Component}

This class displays a table, the columns of which are set up using
TableColumns.

\texttt{set\_button\_bar\_height(x)} sets the height of the buttons at the top
in pixels.

\texttt{set\_contents(x)} sets the contents of the table. The parameter should be
a two\\
 \ \ \ \ \ dimensional list. Each element of the list should correspond
to one row of the table.

\texttt{set\_contents(x, line:1, left\_pos, preserve\_selections)} sets the
contents to x and sets the position to \texttt{line} and
\texttt{left\_pos}. The default \texttt{left\_pos} offset is
the existing position if the window is already open, or zero
otherwise. The
last parameter is a flag that directs whether to retain the current selections.


\texttt{add(c:TableColumn)} adds the given TableColumn to the Table.\\
\texttt{set\_select\_one()} specifies that only one row of the table may be
highlighted.\\
\texttt{set\_select\_many()} allows several rows of the table to be
highlighted.\\
\texttt{get\_selections()} returns a list of the numbers of the rows which are
highlighted.\\
\texttt{set\_selections(L)} sets the line numbers that are selected to the
list of line numbers L.

\noindent{\ttfamily\bfseries \index{TabItem}TabItem : Container}

This class represents a single pane in a TabSet. Components are added to
the TabItem using Container's add() method. They are
then displayed and accept input when that TabItem is selected.
Components added to the TabItem are positioned relative to the position
and size of the parent TabSet. Therefore for example
set\_pos("50\%",
"50\%") refers to the center of the TabSet
rather than the center of the screen. The components also inherit any
window attributes of the TabSet, such as font, color and so on.

\texttt{set\_label(x)} sets the TabItem's label.

{\ttfamily\bfseries
\index{TabSet}TabSet : VisibleContainer}

This class holds the several TabItems.

\texttt{set\_which\_one(x)} sets the displayed TabItem;
default is the first one.\\
\texttt{add(c:TabItem)} adds the given TabItem to the TabSet.

\noindent{\ttfamily\bfseries \index{Panel}Panel : VisibleContainer}

This class simply contains other components. The components inside have
their sizes and positions computed relative to the Panel and also
inherit the Panel's windowing attributes. Components
are added using the add() method of VisibleContainer.

\noindent{\ttfamily\bfseries \index{OverlayItem}OverlayItem : Container}

This class is one "pane" in an OverlaySet,
which is rather like a TabSet except that there are no tabs, and
control over which pane is displayed is entirely the affair of the
program. The components inside have their sizes and positions computed
relative to the parent OverlaySet and also inherit the
OverlaySet's windowing attributes. Components are
added using the add() method of Container.

\noindent{\ttfamily\bfseries \index{OverlaySet}OverlaySet : VisibleContainer}

An OverlaySet is a set of OverlayItems.

\texttt{set\_which\_one(x)} sets the currently displayed OverlayItem;
default is the first.\\
\texttt{add(c:OverlayItem)} adds the given OverlayItem to the OverlaySet.

\section{Plugins}
\index{Plugins}
A Unicon plugin is a dynamically loaded library of routines that are
encapsulated by a class, which provides access to the external routines (often
written in another language) plus a simple facility to enumerate the routines
that are available. The external routines may be part of the source code of the
plugin or in a separately compiled library that is acquired and installed from
elsewhere. At the minimum, a plugin provides a translation layer that converts
the arguments to the routines from their Unicon representation into something
compatible with the calling conventions of the external implementation language;
but usually the plugin also ``adds value'' by providing a more Unicon-like way
of accessing the underlying routines.

\subsection{Bitman}
\index{Bitman plugin}
The \texttt{Bitman} plugin provides low level bit manipulation routines that are
the equivalent of the built-in functions (\texttt{iand}, \texttt{ior},
\texttt{ishift} etc.). The salient differences -- and the reason for their
existence -- between the \texttt{Bitman} methods and the built-in functions is
that the \texttt{Bitman} methods never produce a large integer, are confined to
the natural word length of the machine (so the results are not portable between
32-bit and 64-bit implementations) and, except for bit shifting, do not make a
special case of the sign bit.  \texttt{Bitman} also provides some bit level
enquiry and extraction methods that use a similar addressing convention to
string indexing (indexing bits instead of characters).

The methods provided by the plugin are
\begin{center}
\begin{xtabular}{|m{0.5in}|m{2.5in}|m{0.5in}|}
    \hline
    \texttt{band}   & bitwise AND              & (\texttt{iand})\\
    \texttt{bcom}   & bitwise one's complement & (\texttt{icom})\\
    \texttt{bit}    & (single) bit extraction  &\\
    \texttt{bits}   & enquiry and multi-bit extraction &\\
    \texttt{bor}    & bitwise inclusive OR     & (\texttt{ior})\\
    \texttt{brot}   & bit rotation             &\\
    \texttt{bshift} & bitwise shift            & (\texttt{ishift})\\
    \texttt{bxor}   & bitwise exclusive OR     & (\texttt{ixor})\\
    \texttt{ushift} & unsigned bitwise shift   &\\
    \texttt{test}   & confidence testing       &\\
    \hline
\end{xtabular}
\end{center}
The actual bit manipulation code (written in C) is part of the source code for
the plugin: no external libraries are required. The \texttt{Bitman} class has no
attributes, so the constructor function has no parameters.
\bigskip\hrule\vspace{0.1cm}
\index{band}
\noindent
{\bf band(i, i) : integer } \hfill {\bf bitwise and}

\noindent
\index{bitwise and}\texttt{band(i1, i2)} produces the bitwise AND of
\texttt{i1} and \texttt{i2}.

\bigskip\hrule\vspace{0.1cm}
\index{bcom}
\noindent
{\bf bcom(i) : integer } \hfill {\bf bitwise complement}

\noindent
\texttt{bcom(i)} produces the bitwise complement (one's
complement) of \texttt{i}.

\bigskip\hrule\vspace{0.1cm}
\index{bit}\index{bit extraction}
\noindent
{\bf bit(i, i) : integer ? } \hfill {\bf single bit extraction}

\noindent
\texttt{bit(i,n)} returns the value of the \texttt{n}$^{th}$
bit of \texttt{i}. The indexing works the same way as strings:\\
\texttt{bit(i,1)} is the least significant bit of \texttt{i}.\\
\texttt{bit(i,0)} is the most significant bit of \texttt{i}.\\
\noindent If \texttt{n} is negative, indexing is from the most significant end,
otherwise it is from the least significant end.

\bigskip\hrule\vspace{0.1cm}
\index{bits}\index{multi-bit extraction}
\noindent
{\bf bits(i, i, i) : integer ? } \hfill {\bf multi-bit extraction}

\noindent
\texttt{bits(i,n,m)} returns the value of the \texttt{n}$^{th}$ to the
\texttt{m}$^{th}$ bit of \texttt{i}. The value is shifted down to the
least significant end of the machine word. The bits are {\em not\/} reversed if
\verb|m < n|.

\noindent \texttt{bits()} returns the number of bits in a word -- usually 32 or 64.

\bigskip\hrule\vspace{0.1cm}
\index{brot}
\noindent
{\bf brot(i, i) : integer } \hfill {\bf bitwise rotation}

\noindent
\index{bit rotation}\texttt{brot(i, j)} produces the value obtained by
rotating \texttt{i} by \texttt{j} bit positions.
If \texttt{j} is positive, the rotation is to the left;
if \texttt{j} is negative, the rotation is to the right.

\bigskip\hrule\vspace{0.1cm}
\index{bor}
\noindent
{\bf bor(i, i) : integer } \hfill {\bf bitwise or}

\noindent
\index{bitwise or}\texttt{bor(i1, i2)} produces the bitwise OR of
\texttt{i1} and \texttt{i2}.

\bigskip\hrule\vspace{0.1cm}
\index{bshift}
\noindent
{\bf bshift(i, i) : integer } \hfill {\bf signed bitwise shift}

\noindent
\index{signed shift}\texttt{bshift(i, j)} produces the value obtained by
shifting \texttt{i} by \texttt{j} bit positions.
If \texttt{j} is positive, the shift is to the left, and vacated bit
positions are filled with zeros.
If \texttt{j} is negative, the shift is to the right with sign extension.

\bigskip\hrule\vspace{0.1cm}
\index{ushift}
\noindent
{\bf ushift(i, i) : integer } \hfill {\bf unsigned bitwise shift}

\noindent
\index{unsigned shift}\texttt{ushift(i, j)} produces the value obtained by
shifting \texttt{i} by \texttt{j} bit positions.
The shift is to the left, if \texttt{j} is positive, or to the right if
\texttt{j} is negative.  Vacated bit positions are filled with zeros.

\subsection{SecureHash}
\index{SecureHash plugin}
The \texttt{SecureHash} plugin provides access to an implementation of the
RFC6324 secure hash routines. This is an extract from the description:
\begin{quote}
{\small
  This file implements the Secure Hash Algorithms
  as defined in the U.S. National Institute of Standards
  and Technology Federal Information Processing Standards
  Publication (FIPS PUB) 180-3 published in October 2008
  and formerly defined in its predecessors, FIPS PUB 180-1
  and FIP PUB 180-2.

  A combined document showing all algorithms is available at\\
  http://csrc.nist.gov/publications/fips/fips180-3/fips180-3\_final.pdf

  The five hashes are defined in these sizes:\\
  \begin{xtabular}{m{1.0in}m{3.0in}}
      \texttt{SHA-1}       &    20 byte / 160 bit\\
     \texttt{SHA-224}     &    28 byte / 224 bit\\
     \texttt{SHA-256}     &    32 byte / 256 bit\\
     \texttt{SHA-384}     &    48 byte / 384 bit\\
     \texttt{SHA-512}     &    64 byte / 512 bit\\
   \end{xtabular}
}
\end{quote}

\noindent Modified versions of the RFC6324 routines -- to make them thread-safe
-- are included in the source code of the plugin: no external libraries are
required.

Access to the hashing routines is provided at two levels
\begin{itemize}
  \item The higher (and most convenient) level is provided by the
    \texttt{SecureHash} class using the \texttt{Sha} method.
  \item At the lower level, the individual RFC6324 routines may be accessed
    directly, without using the \texttt{SecureHash} class, via the interface
    procedures provided by the plugin.
\end{itemize}

\noindent
Parameters to \texttt{Sha} may be strings, csets, open files, numbers, records or lists.\\
   String parameters are ``fed to the underlying hash routines'' ({\em fttuhr});\\
   if the parameter is a cset, each character in the set is {\em fttuhr\/};\\
   if the parameter is an open file, each line of the file is read and {\em fttuhr\/};\\
   if the parameter is a number, it is converted to a string and {\em fttuhr\/}.\\
\noindent
\texttt{Sha} applies itself recursively to list or record parameters (depth
first traversal). So records and lists may contain strings, csets, open files,
numbers, records or lists. \texttt{Sha} is tolerant of null parameters and empty
strings, csets, files or lists; they have no effect on the final hash value.

Sets and Tables are not allowed as parameters to \texttt{Sha} because their order of
enumeration is not defined. Any other type (thread, co-expression, window ...)
is also disallowed by fiat, with one exception: A procedure value%
\footnote{
A procedure value is a convenient way to steer the operation of the
\texttt{Sha} routine because it cannot be confused with any data to be added to
the hash value.}%
, using special ``command procedures'', may be used to signal that \texttt{Sha}
should take some special action as follows:
\begin{itemize}
  \item
    The procedure \texttt{More} is allowed as the final parameter. Normally the
    \texttt{Sha} method returns the secure hash of all its parameters, but if
    the final parameter is the procedure \texttt{More}, subsequent calls to
    \texttt{Sha} will continue the hashing operation.
    Note the style is
\iconcode{ Sha( ... , More ) }
\noindent rather than
\iconcode{
  Sha( ... , More() )
}
\noindent although the latter has been made to work as a ``concession to ease of use''.

\item
  The procedures \texttt{Final1} ... \texttt{Final7} may be used to signal that
  the final parameter to \texttt{Sha} is not a whole octet, only the specified
  number of bits are to be included in the hash. These procedures are only
  allowed just before the final parameter.  Where the final number of bits is
  calculated, the \texttt{Final(expr)} procedure may be
  used. \verb|0 <= expr <= 8|. (There is a \texttt{Final0} procedure, but using
  it explicitly would be slightly odd, since it will cause the final parameter
  to be ignored. There is also a \texttt{Final8} procedure which causes all of
  the final parameter to be included. These procedures are intended for use by
  the \texttt{Final} procedure).

\item
  The \texttt{Raw} procedure switches the default output from a string of
  hexadecimal characters to a string of half the length containing the actual
  bits returned by the RFC6234 result procedure. It may be placed anywhere in
  the list of parameters.
\end{itemize}

Note that \texttt{Sha(number)} will return a secure hash of the string
representation of the number, not a hash of the underlying bits. If a hash of
the bits is required, the only way to do it is to convert the number to a string
of the correct length (and endianness) without altering the value of the bits
-- Unicon strings may contain characters with all values from 0 to 255 -- this
also applies to the lower level \texttt{sha\_Input} procedure

Once \texttt{Sha} has produced a hash value (or failed) it will automatically
reset the underlying hash routines the next time it is called.

The \texttt{SecureHash} class is not thread-safe. \WarningNotThreadSafe
Using a shared \texttt{SecureHash} object in different threads without mutual
exclusion is unlikely to produce predictable results. Using a
\texttt{SecureHash} object that is private to each thread {\em is\/} safe
because the underlying hash routines are thread-safe.

The class is initialized with an optional string parameter that determines the
hash algorithm. Valid strings are \texttt{"SHA1"}, \texttt{"SHA224"},
\texttt{"SHA256"}, \texttt{"SHA384"} or \texttt{"SHA512"}.  The default is
\texttt{"SHA512"}.


The methods of the \texttt{SecureHash} class are:

\bigskip\hrule\vspace{0.1cm}
\index{Reset}
\noindent
{\bf Reset(s : "SHA512") : ? } \hfill {\bf Reset Secure Hash}

\noindent
\index{Reset()}\texttt{Reset(s)} re-initializes the secure hash instance.  The
optional parameter specifies the algorithm to use and must be one of \texttt{"SHA1"},
\texttt{"SHA224"}, \texttt{"SHA256"}, \texttt{"SHA384"} or \texttt{"SHA512"}.

\bigskip\hrule\vspace{0.1cm}
\index{Sha}
\noindent
{\bf Sha(any?, ...) : string ? } \hfill {\bf Secure Hash}

\noindent
\index{Sha()}\texttt{Sha(...)} returns the secure hash value of its
arguments, which are of the types discussed above.

\bigskip
The interface procedures of the \texttt{SecureHash} plugin are:

\bigskip\hrule\vspace{0.1cm}
\index{shaFunction}
\noindent
{\bf shaFunction(s?) : string ? } \hfill {\bf Set/Get default Hash function}

\noindent
\index{shaFunction()}
\texttt{shaFunction(h)} sets the default hash algorithm.  Valid strings are
\texttt{"SHA1"}, \texttt{"SHA224"}, \texttt{"SHA256"}, \texttt{"SHA384"} or
\texttt{"SHA512"}.  \texttt{shaFunction()} returns the name of the current
default algorithm.  The procedure is not thread-safe. \WarningNotThreadSafe

\bigskip\hrule\vspace{0.1cm}
\index{sha_Reset}
\noindent
{\bf sha\_Reset(s) : ctx ? } \hfill {\bf Initialize Secure Hash}

\noindent
\index{sha_Reset()}
\texttt{sha\_Reset(h)} initializes and returns an opaque context value that
should be fed into the other interface procedures. \texttt{h} determines the
hash algorithm. Valid strings are \texttt{"SHA1"}, \texttt{"SHA224"},
\texttt{"SHA256"}, \texttt{"SHA384"} or \texttt{"SHA512"}.

\bigskip\hrule\vspace{0.1cm}
\index{sha_Input}
\noindent
{\bf sha\_Input(ctx, s) : ? } \hfill {\bf Hash String}

\noindent
\index{sha_Input()}
\texttt{sha\_Input(x, s)} Adds the secure hash of \texttt{s} to the hash value
stored in \texttt{x}.

\bigskip\hrule\vspace{0.1cm}
\index{sha_FinalBits}
\noindent
{\bf sha\_FinalBits(ctx, c, i) : ? } \hfill {\bf Hash the final partial octet}

\noindent
\index{sha_FinalBits()}
\texttt{sha\_FinalBits(x, c, n)} Adds the secure hash of the most significant
\texttt{n} bits of \texttt{c} to the hash value stored in \texttt{x}.
\verb|1 <= n <= 7|

\bigskip\hrule\vspace{0.1cm}
\index{sha_RawResult}
\noindent
{\bf sha\_RawResult(ctx) : string ? } \hfill {\bf Return the raw hash value}

\noindent
\index{sha_RawResult()}
\texttt{sha\_RawResult(x)} returns the final hash value in the exact form
returned by the RFC6324 hash routines. The returned string will be a binary
string and may contain any character value from \texttt{char(0)} to
\texttt{char(255)}.

\bigskip\hrule\vspace{0.1cm}
\index{sha_Result}
\noindent
{\bf sha\_Result(ctx) : string ? } \hfill {\bf Return the hash value}

\noindent
\index{sha_Result()}
\texttt{sha\_Result(x)} returns the final hash value converted to a string of
hexadecimal characters.

\subsection{SQLite}
The \texttt{SQLite} plugin provides access to version 3 of the SQLite database
engine. The SQLite software must be downloaded from
\url{https://sqlite.org/download.html} (or from a mirror or a distribution specific
site) and installed: the plugin does not provide it.

SQLite is a {\em transactional\/} database: all reads and writes take place
within a transaction -- either explicitly started by the application, or
implicitly by SQLite itself -- and a transaction is {\em atomic\/}; either all
of the modifications in the transaction succeed or none of them do.  SQLite
supports many readers but only one writer at a time. To resolve conflicts
between incompatible access requirements, requests are queued. Sometimes the
error \texttt{SQLITE\_BUSY} is returned to signal that the database is in use
and to try again later.  See \url{https://sqlite.org/transactional.html} and
\url{https://sqlite.org/lang_transaction.html} for more details.

\medskip
\index{SQLite Plugin}
The plugin gives access at three levels:
\begin{enumerate}
\item
  The lowest level provides access to the SQLite API. There are almost 300
  routines in the API and, at present, this level only provides access to the
  routines that are used by the higher levels of the plugin. However, given
  the examples provided here, it is comparatively easy to extend this level to
  provide a routine that is missing.
\item
  The next level consists of utility procedures that use routines in level 1 to
  return the rows of an SQL query as a Unicon data structure (list, set,
  table). This level makes no attempt to deal with \texttt{SQLITE\_BUSY},
  passing that error back to the caller to be dealt with there.
\item
  The highest level is a simple class, built on the routines in level 2, that
  encapsulates an SQLite database connection (and, to a large extent, handles
  \texttt{SQLITE\_BUSY}).  SQLite is transactional but SQLite transactions may
  not be nested. The class provides limited support for what {\em appears\/} to
  be nested transactions allowing calls to start and finish a transaction to be
  nested%
  \footnote{
   Methods like \texttt{SQL\_As\_List} use transactions
   internally to guarantee the consistency of the answer.
  }-- which allows routines that use a transaction to be called from other
  routines that themselves use a transaction. In reality, there is only ever one
  (the outermost) transaction.

  There is also a derived class (\texttt{RO\_SQLite})that provides a
  ``read-only'' interface, which allows reading from the database but
  prohibits its alteration.
\end{enumerate}

The thread safety of the \texttt{SQLite} plugin is a complicated question.
In summary, the external SQLite library itself {\em is\/} thread-safe but the
plugin is not; \WarningNotThreadSafe however, it can be used in a thread-safe
manner with a little extra effort.  See below (page \pageref{SQLite_ThreadSafety})
for more detail.

\subsubsection{The \texttt{SQLite} class}
\label{SQLiteClass}
The class is initialized with a string parameter that is the file name of the
database together with an optional timeout parameter -- discussed below on page
\pageref{SQLite_Timeout}  -- the default is 5 seconds.

\noindent
A simple example of the use of the \texttt{SQLite} class may be found in the
\texttt{testSQLite.icn} file that accompanies the source code of the plugin.
Using the class methods, the program creates a simple database of squares, cubes
and fourth powers of the numbers from one to ten. It then checks the values
returned by other methods of the class.

\noindent
The methods of the \texttt{SQLite} class are:
\bigskip\hrule\vspace{0.1cm}
\index{BEGIN}
\noindent
{\bf BEGIN() : ? } \hfill {\bf Start a database transaction}

\noindent
\texttt{BEGIN()} declares the start of an SQLite transaction: alterations to
the database between \texttt{BEGIN()} and \texttt{END()} will either {\em
  all\/} succeed or, none of them will succeed. Calls to \texttt{BEGIN} may
be nested for convenience but note that SQLite does not support nested
transactions: from the point of view of the database software there is only
ever one transaction -- the nested transactions are a fiction provided by the
\texttt{SQLite} class so that functions which, in isolation, call for a
transaction may be conveniently amalgamated into a single overall transaction.
After a successful call of \texttt{BEGIN} the \texttt{SQLITE\_BUSY} status will
not be returned by any SQLite routine up to (but not including) the
corresponding call of \texttt{END}.

\bigskip\hrule\vspace{0.1cm}
\index{END}
\noindent
{\bf END() : ? } \hfill {\bf Complete a database transaction}

\noindent
\texttt{END()} declares the end of an SQLite transaction. If the call
succeeds, all modifications to the database after the call of the
corresponding call to \texttt{BEGIN} will have succeeded.

\bigskip\hrule\vspace{0.1cm}
\index{ROLLBACK}
\noindent
{\bf ROLLBACK() : ? } \hfill {\bf Abandon a database transaction}

\noindent
\texttt{ROLLBACK()} declares the end of an SQLite transaction. If the call
succeeds, all modifications to the database after the call of the
outermost call to \texttt{BEGIN} will have been undone and the state of
the database will be as it was just before the call to \texttt{BEGIN}.

\bigskip\hrule\vspace{0.1cm}
\index{Close}
\noindent
{\bf Close() : } \hfill {\bf Close a database}

\noindent
\texttt{Close()} closes a database connection and recovers resources. If
\texttt{Close} is called during a transaction, the transaction is automatically
rolled back.

\bigskip\hrule\vspace{0.1cm}
\index{Exec}
\noindent
{\bf Exec(s, ...) : row|val? } \hfill {\bf Execute SQL}

\noindent
\texttt{Exec(sql)} prepares the SQL query in \texttt{sql} and then uses the
SQLite library to execute it. The query should return, at most, one row of data.
If the query asks for more than one value the values will be returned in a
record whose field names are the names used in the query. A query that asks for a
single value results in that value being returned directly (rather than a record
with a single field). A query that results in no data being returned will either
succeed or fail.  \texttt{Exec(sql, p1, p2 ...)}  will bind the parameters to
the query before execution.

\bigskip\hrule\vspace{0.1cm}
\index{thing}
\noindent
{\bf ErrMsg() : string } \hfill {\bf Return the most recent error message}

\noindent
\texttt{ErrMsg()} returns a string (in English) that describes the most recent
error detected by the SQLite database routines.

\bigskip\hrule\vspace{0.1cm}
\index{isTable}
\noindent
{\bf isTable(s) :  ? } \hfill {\bf Test if a SQL table exists}
    
\noindent
\texttt{isTable(t)} succeeds if the SQL table \texttt{t} exists in the database.

\bigskip\hrule\vspace{0.1cm}
\index{Rows}
\noindent
{\bf Rows(s) : integer ? } \hfill {\bf Count rows in a SQL table}
    
\noindent
\texttt{Rows(t)} returns the number of rows in the SQL table \texttt{t}.

\bigskip\hrule\vspace{0.1cm}
\index{SQL_Row}
\noindent
{\bf SQL\_Row(s, ... ) : row * } \hfill {\bf Get data from a query}

\noindent
\texttt{SQL\_Row(sql, ...)} prepares the query in \texttt{sql} and then returns
the data one row at a time. The data is in the same form as \texttt{Exec} -- a
record with named fields or a single value.  Note that calling \texttt{SQL\_Row}
fewer times than there are available rows will leak memory until the database
connection is closed.

\bigskip\hrule\vspace{0.1cm}
\index{SQL_As_List}
\noindent
{\bf SQL\_As\_List(s, ...) : list ? } \hfill {\bf Return query data as a list}

\noindent
\texttt{SQL\_As\_List(sql, ...)}  prepares the query in \texttt{sql} and returns
the results in a list. The list elements will either be records with named
fields or single values (same format as \texttt{Exec}).

\bigskip\hrule\vspace{0.1cm}
\index{SQL_As_Set}
\noindent
{\bf SQL\_As\_Set(s, ...) : set ? } \hfill {\bf Return query data as a set}

\noindent
\texttt{SQL\_As\_Set(sql, ...)}  prepares the query in \texttt{sql} and returns
the results in a set. The set elements will either be records with named
fields or single values (same format as \texttt{Exec}).

\bigskip\hrule\vspace{0.1cm}
\index{SQL_As_Table}
\noindent
{\bf SQL\_As\_Table(s, i : 1, ...) : table ? } \hfill {\bf Return query data as a table}

\noindent
\texttt{SQL\_As\_Table(sql, n, ...)}  prepares the query in \texttt{sql} and
returns the results in a Unicon table whose keys are taken from column \texttt{n} of
the query data. The table element values will always be records, even if the
data rows have only one value (and will include the indexing column value). If
the indexing column has duplicate values then later rows will overwrite earlier
rows with the same key.

\subsubsection{Thread safety of the \texttt{SQLite} class}
\label{SQLite_ThreadSafety}
The main reason that the \texttt{SQLite} class is not thread-safe is down to how
\WarningNotThreadSafe it handles transactions. SQLite itself supports multiple
simultaneous read transactions coming from separate database connections,
possibly in separate threads or processes, but only one simultaneous write
transaction. Each instance of the \texttt{SQLite} class counts how many
\texttt{BEGIN} methods are active on its connection and only isues a
\texttt{BEGIN IMMEDIATE TRANSACTION} statement for the outermost (first) call
and only issues a \texttt{COMMIT} statement when the outermost \texttt{END}
method is called.  If the instance is shared between threads then it is easy for
this count to become confused, leading to a \texttt{COMMIT} statement being
executed at an inappropriate point.

To avoid this, use a separate instance of the class in each thread. Doing so
avoids most (but not all) problems. If concurrent access is made to the database
from separate threads then it is possible that the \texttt{SQLITE\_BUSY} error
is returned.  The \texttt{BEGIN} and \texttt{END} methods handle this by
delaying for a short time and retrying but they will fail if the total time
taken is more than the wait time specified in the initialization of the
\label{SQLite_Timeout}
class. Hence a program that uses concurrent access and has transactions that
might take a long time must be prepared to deal with the failure.

An alternative design which avoids these problems is to use a single database
access thread to serialize all SQL queries and to use Unicon's message passing
facilities to send queries and receive answers.  If there is a mixture of read
and write requests the reduction in parallelism (compared with one class
instance per thread) is not as drastic as it appears because the reduction in
parallel queries has {\em already\/} occurred due to the way the \texttt{SQLite}
class uses transactions -- each method uses \texttt{BEGIN} and \texttt{END}
internally to make sure that methods like \texttt{SQL\_As\_List} return a
consistent set of data and don't fail in the middle of constructing the list.
However, if most of the queries are read only, this design will reduce the number
of concurrent queries dramatically (to one).

There is, in essence, an unfortunate trade-off between performance and
convenience: for maximum throughput the only way is to eschew the
\texttt{SQLite} class, use the utility procedures or the low level interface
routines explicitly, do as much as possible in parallel and deal with
\texttt{SQLITE\_BUSY} wherever it occcurs.  In practice, the \texttt{SQLite}
class performs tolerably well and it is only those applications that demand the
best performance and the highest possible level of parallel access to the
database that may feel the need to replace it. In those circumstances, it
might also be fruitful to reconsider the use of an interpreted language.

\subsubsection{The \texttt{SQLite} utility procedures}
There is a deliberate similarity in names between the methods of the
\texttt{SQLite} class and the utility procedures used by them. The functionality
is largely the same with the significant exception that the utility procedures
make no attempt to handle \texttt{SQLITE\_BUSY} -- that error is passed back
to the caller to be dealt with there. In many cases, the class method just
wraps the utility procedure it uses in \texttt{BEGIN} \ldots \texttt{END} calls.

The utility procedures of the \texttt{SQLite} plugin are:
\bigskip\hrule\vspace{0.1cm}
\index{SQLi_isTable}
\noindent
{\bf SQLi\_isTable(s) :  ? } \hfill {\bf Test if a SQL table exists}
    
\noindent
\texttt{SQLi\_isTable(t)} succeeds if the SQL table \texttt{t} exists in the database.

\bigskip\hrule\vspace{0.1cm}
\index{SQLi_Rows}
\noindent
{\bf SQLi\_Rows(s) : integer ? } \hfill {\bf Count rows in a SQL table}
    
\noindent
\texttt{SQLi\_Rows(t)} returns the number of rows in the SQL table \texttt{t}.

\bigskip\hrule\vspace{0.1cm}
\index{SQLi_Exec}
\noindent
{\bf SQLi\_Exec(s, ...) : row|val? } \hfill {\bf Execute SQL}

\noindent
\texttt{SQLi\_Exec(sql)} prepares the SQL query in \texttt{sql} and then uses
the SQLite library to execute it. The query should return, at most, one row of
data.  If the query asks for more than one value the values will be returned in
a record whose field names are the names used in the query. A query that asks for a
single value results in that value being returned directly (rather than a record
with a single field). A query that results in no data being returned will either
succeed or fail.  \texttt{SQLi\_Exec(sql, p1, p2 ...)}  will bind the parameters
to the query before execution.

\bigskip\hrule\vspace{0.1cm}
\index{SQLi_Row}
\noindent
{\bf SQLi\_Row(s, ... ) : row * } \hfill {\bf Get data from a query}

\noindent
\texttt{SQLi\_Row(sql, ...)} prepares the query in \texttt{sql} and then returns
the data one row at a time. The data is in the same form as \texttt{SQLi\_Exec} -- a
record with named fields or a single value.  Note that calling \texttt{SQLi\_Row}
fewer times than there are available rows will leak memory until the database
connection is closed.

\bigskip\hrule\vspace{0.1cm}
\index{SQLi_As_List}
\noindent
{\bf SQLi\_As\_List(s, ...) : list ? } \hfill {\bf Return query data as a list}

\noindent
\texttt{SQLi\_As\_List(sql, ...)}  prepares the query in \texttt{sql} and returns
the results in a list. The list elements will either be records with named
fields or single values (same format as \texttt{SQLi\_Exec}).

\bigskip\hrule\vspace{0.1cm}
\index{SQLi_As_Set}
\noindent
{\bf SQLi\_As\_Set(s, ...) : set ? } \hfill {\bf Return query data as a set}

\noindent
\texttt{SQLi\_As\_Set(sql, ...)}  prepares the query in \texttt{sql} and returns
the results in a set. The set elements will either be records with named
fields or single values (same format as \texttt{SQLi\_Exec}).

\bigskip\hrule\vspace{0.1cm}
\index{SQLi_As_Table}
\noindent
{\bf SQLi\_As\_Table(s, i : 1, ...) : table ? } \hfill {\bf Return query data as a table}

\noindent
\texttt{SQLi\_As\_Table(sql, n, ...)}  prepares the query in \texttt{sql} and
returns the results in a Unicon table whose keys are taken from column
\texttt{n} of the query data. The table element values will always be records,
even if the data rows have only one value (and will include the indexing column
value). If the indexing column has duplicate values then later rows will
overwrite earlier rows with the same key.
\subsubsection{The \texttt{SQLite} interface routines}

The plugin uses a small subset of the three hundred or so routines in the SQLite
API. There is comprehensive documentation on each of the individual routines
provided by the \texttt{SQLite} library at
\url{https://www.sqlite.org/docs.html} and no attempt is made to reproduce that
material here.  Each of the interface procedures provided by the plugin checks
that the supplied parameters are of the correct type, converts them from their
Unicon representation into something that conforms to the \texttt{C} calling
convention and passes them down to the underlying SQLite library routine.

It is anticpated that most users will not call these routines directly; instead,
preferring to use the \texttt{SQLite} class interface or the higher level
utility procedures of the plugin.

\medskip
\noindent
\tablehead{%
  \hline
  Interface procedure & SQlite routine & Notes\\
  \hline
}%
\tabletail{%
  \hline
  \multicolumn{3}{|r|}{\small continued \ldots}\\
  \hline
}%
\tablelasttail{\hline}%
\begin{xtabular}{|>{\small\texttt\bgroup}m{1.8in}<{\egroup}%
    >{\small\texttt\bgroup}m{1.5in}<{\egroup}%
    |>{\small\bgroup}p{3.2in}<{\egroup}|}
  SQLi\_Init(x?) : & sqlite3\_config &
  This procedure should be called before any other interface routine. If the
  parameter is null, column numbers will start at one. If non-null they will
  start at zero. The higher level routines and the \texttt{SQlite} class
  assume that the column numbers start at one.\smallskip\\
  %
  \hline
  SQLi\_libversion() : s & sqlite3\_libversion &
  Returns the version of the SQLite library as a string.\\
  %
  SQli\_libversion\_number() : i & sqlite3\_libversion\_number &
  Returns the version of the SQLite library as an integer.\\
  %
  \hline
  SQLi\_open(s, s?) : ctx? & sqlite3\_open\_V2 &
  Open (or create) the database named by the first parameter. The second
  parameter is \texttt{"b"} for read/write access and anything else for
  read-only access.\\
  %
  \hline
  SQLi\_close(ctx) : & sqlite3\_close\_V2 &
  Close the database connection.\\
  %
  \hline
  SQLi\_prepare(ctx, s) :sqst? & sqlite3\_prepare\_V2 &
  Compile (prepare for execution) the SQL statement \texttt{s}.\\
  %
  \hline
  SQLi\_bindArg(sqst, i, x) : ? &
  \begin{tabular}{l}
    sqlite3\_bind\_null\\
    sqlite3\_bind\_int64\\
    sqlite3\_bind\_double\\
    sqlite3\_bind\_text\\
  \end{tabular}
  &
  Bind a single parameter \texttt{x} to the column specified by
  \texttt{i}. \texttt{x} may be null, integer, real or a string.\\
  %
  \hline
  SQLi\_bind(sqst, x, ...) : ? &
  \begin{tabular}{l}
    sqlite3\_bind\_null\\
    sqlite3\_bind\_int64\\
    sqlite3\_bind\_double\\
    sqlite3\_bind\_text\\
  \end{tabular}
  &
  Bind parameters, starting at the first column.
  Each parameter may be null, integer, real or a string.\\
  %
  \hline
  SQLi\_step(sqst, i: 0) : ?  & sqlite3\_step &
  Evaluate (execute) the prepared statement. A status return of
  \texttt{SQLITE\_BUSY} will cause the program to stop unless \texttt{i} is non
  zero.\\
  %
  \hline
  SQLi\_errmsg(ctx) : s & sqlite3\_errmsg &
  Return the most recent error message.\\
  %
  %\hline
  SQLi\_Error(i) : s & sqlite3\_errstr &
  \texttt{SQLi\_Error(n)} returns the error message associated with the return
  status \texttt{n}.\\
  %
  \hline
  SQLi\_column\_count(sqst) : i & sqlite3\_column\_count &
  Return the number of columns in the result set returned by the prepared statement.\\
  %
  \hline
  SQLi\_column\_type(sqst, i) : i & sqlite3\_column\_type &
  Return the data type code of the specified column in the result set returned by
  the prepared statement.\\
  %
  \hline
  SQLi\_column\_name(sqst, i) : s & sqlite3\_column\_name &
  Return the assigned name of the specified column in the result set returned by
  the prepared statement.\\
  %
  \hline
  SQLi\_column\_string(sqst, i) : s & sqlite3\_column\_text &
  Return the value of the specified column as a string.\\
  %
  \hline
  SQLi\_column\_integer(sqst, i) : i & sqlite3\_column\_int64 &
  Return the value of the specified column as an integer.\\
  %
  \hline
  SQLi\_column\_real(sqst, i) : r & sqlite3\_column\_double &
  Return the value of the specified column as a real number.\\
  %
  \hline
  SQLi\_column(sqst, i) : x &
    \begin{tabular}{l}
    sqlite3\_column\_type\\
    sqlite3\_column\_int64\\
    sqlite3\_column\_double\\
    sqlite3\_column\_text\\
    \end{tabular} &
    Return the value of the specified column as specified by its data type code.\\
  %
  \hline
  SQLi\_finalize(sqst) & sqlite3\_finalize &
  Recover resources from a prepared SQL statement after execution.\\
  \multicolumn{3}{|p{6.5in}|}{\small
    Although the SQLite documentation is generally not repeated here, it is
    worth emphasizing this extract:
    \begin{quote}
    The application must finalize every prepared statement in order to avoid
    resource leaks. It is a grievous error for the application to try to use a
    prepared statement after it has been finalized. Any use of a prepared
    statement after it has been finalized can result in undefined and
    undesirable behavior such as segfaults and heap corruption.
    \end{quote}
  }\\
  \hline
\end{xtabular}
% Be considerate of other uses of xtabular later on in the book that might not
% expect these macros to have anything in them.
\tablefirsthead{}%
\tablehead{}%
\tabletail{}%
\tablelasttail{}%
